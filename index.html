<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–Å–ª–∫–∞</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div class="app-root">

  <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ -->
  <section id="role-screen" class="screen screen-active">
    <div class="role-card">
      <div class="logo-text">–Å –ª –∫ –∞</div>

      <label class="field-label" for="role-select">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</label>
      <div class="select-wrapper">
        <select id="role-select" class="input-select">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
          <option value="dispatcher">–î–∏—Å–ø–µ—Ç—á–µ—Ä</option>
          <option value="citizen">–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π</option>
          <option value="forces">–°–∏–ª–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</option>
          <option value="rescue">–°–ª—É–∂–±–∞ —Å–ø–∞—Å–µ–Ω–∏—è</option>
        </select>
      </div>

      <button id="role-continue" class="btn btn-primary">
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </button>
    </div>
  </section>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω -->
  <section id="main-screen" class="screen">
    <header class="topbar">
      <div class="topbar-left">
        <img src="img/logo.svg" alt="–Å–ª–∫–∞" class="topbar-logo" />
        <span class="topbar-title">–Å –ª –∫ –∞</span>
        <span id="current-role" class="topbar-role"></span>
      </div>
      <div class="topbar-right">
        <button class="icon-btn" title="–£–º–µ–Ω—å—à–∏—Ç—å —à—Ä–∏—Ñ—Ç">‚àí</button>
        <span class="counter" title="–ß–∏—Å–ª–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤" id="active-calls-count">0</span>
        <button class="icon-btn" title="–£–≤–µ–ª–∏—á–∏—Ç—å —à—Ä–∏—Ñ—Ç">+</button>
        <button class="icon-btn" title="–¢–µ–º–∞">üåô</button>
        <button class="icon-btn" id="logout-btn" title="–í—ã—Ö–æ–¥">‚ü≤ –í—ã—Ö–æ–¥</button>
      </div>
    </header>

    <main class="main-layout">

      <!-- *******************************
           –í–ò–î –î–õ–Ø –î–ò–°–ü–ï–¢–ß–ï–†–ê
      ******************************** -->
      <div id="dispatcher-view" class="role-view">
        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –≤—ã–∑–æ–≤—ã -->
        <section class="card">
          <header class="card-header">
            <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –≤—ã–∑–æ–≤—ã</h2>
            <button class="btn btn-ghost" id="history-btn">‚ü≤ –ò—Å—Ç–æ—Ä–∏—è</button>
          </header>

          <form id="call-form" class="form-grid">
            <div class="form-group">
              <label for="call-street">–£–ª–∏—Ü–∞ *</label>
              <input id="call-street" class="input-text" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —É–ª–∏—Ü—É" required />
            </div>
            <div class="form-group">
              <label for="call-desc">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
              <input id="call-desc" class="input-text" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ" required />
            </div>
            <div class="form-group form-group-buttons">
              <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –≤—ã–∑–æ–≤</button>
              <button type="button" class="btn btn-secondary" id="ai-generate-btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ò–ò</button>
            </div>
          </form>

          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID –≤—ã–∑–æ–≤–∞</th>
                  <th>–£–ª–∏—Ü–∞</th>
                  <th>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è</th>
                  <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–†–µ—Å—É—Ä—Å—ã</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="calls-table-body"></tbody>
            </table>
          </div>
        </section>

        <!-- –°–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ -->
        <section class="card">
          <header class="card-header">
            <h2>–°–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤</h2>
          </header>

          <form id="resource-form" class="form-grid form-grid-4">
            <div class="form-group">
              <label for="res-name">–ò–º—è</label>
              <input id="res-name" class="input-text" type="text" placeholder="–ù–∞–ø—Ä., –ü–∞—Ç—Ä—É–ª—å 12" />
            </div>
            <div class="form-group">
              <label for="res-app">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</label>
              <input id="res-app" class="input-text" type="text" placeholder="–†–∞—Ü–∏—è, Telegram..." />
            </div>
            <div class="form-group">
              <label for="res-status">–°—Ç–∞—Ç—É—Å</label>
              <select id="res-status" class="input-select">
                <option value="–°–≤–æ–±–æ–¥–µ–Ω">–°–≤–æ–±–æ–¥–µ–Ω</option>
                <option value="–ó–∞–Ω—è—Ç">–ó–∞–Ω—è—Ç</option>
                <option value="–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω">–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω</option>
              </select>
            </div>
            <div class="form-group">
              <label for="res-call">–ó–∞–∫—Ä–µ–ø–ª—ë–Ω –∑–∞ –≤—ã–∑–æ–≤–æ–º</label>
              <select id="res-call" class="input-select">
                <option value="">‚Äî –ù–µ—Ç ‚Äî</option>
              </select>
            </div>
            <div class="form-group form-group-buttons">
              <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Å—É—Ä—Å</button>
            </div>
          </form>

          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>–ò–º—è</th>
                  <th>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–í—ã–∑–æ–≤</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="resources-table-body"></tbody>
            </table>
          </div>
        </section>

        <!-- –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∏ -->
        <section class="card">
          <header class="card-header">
            <h2>–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∏</h2>
            <button class="btn btn-primary" id="add-orientation-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
          </header>

          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>–¢–∏–ø</th>
                  <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                  <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                  <th>–î–µ–π—Å—Ç–≤—É–µ—Ç</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="orientation-table-body"></tbody>
            </table>
          </div>
        </section>

        <!-- –ö–∞—Ä—Ç–∞ -->
        <section class="card">
          <header class="card-header">
            <h2>–ö–∞—Ä—Ç–∞</h2>
          </header>

          <div class="map-container">
            <iframe
              src="https://map.vzkn.ru/"
              allowfullscreen
              loading="lazy">
            </iframe>
          </div>
        </section>

        <!-- –ó–∞–º–µ—Ç–∫–∏ -->
        <section class="card">
          <header class="card-header">
            <h2>–ó–∞–º–µ—Ç–∫–∏ <span id="notes-status" class="muted">–ó–∞–≥—Ä—É–∂–µ–Ω–æ</span></h2>
          </header>
          <textarea id="notes-field" class="notes-area" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ –∑–¥–µ—Å—å..."></textarea>
        </section>
      </div>

      <!-- *******************************
           –í–ò–î –î–õ–Ø –ì–†–ê–ñ–î–ê–ù–°–ö–û–ì–û
      ******************************** -->
      <div id="citizen-view" class="role-view">
        <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ -->
        <section class="card">
          <header class="card-header">
            <h2>–ú–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ <span id="persons-count" class="muted"></span></h2>
            <button id="add-person-btn" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
          </header>

          <div id="persons-grid" class="cards-grid">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
          </div>
        </section>

        <!-- –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ -->
        <section class="card">
          <header class="card-header">
            <h2>–ú–æ–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ <span id="vehicles-count" class="muted"></span></h2>
            <button id="add-vehicle-btn" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</button>
          </header>

          <div id="vehicles-grid" class="cards-grid">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
          </div>
        </section>
      </div>

      <!-- –ú–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤–∏–¥—ã –¥–ª—è —Å–∏–ª–æ–≤—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –∏ —Å–ª—É–∂–±—ã —Å–ø–∞—Å–µ–Ω–∏—è -->
      <div id="forces-view" class="role-view">
        <section class="card">
          <header class="card-header">
            <h2>–°–∏–ª–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</h2>
          </header>
          <p>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–æ–ª–∏ ¬´–°–∏–ª–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã¬ª –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
        </section>
      </div>

      <div id="rescue-view" class="role-view">
        <section class="card">
          <header class="card-header">
            <h2>–°–ª—É–∂–±–∞ —Å–ø–∞—Å–µ–Ω–∏—è</h2>
          </header>
          <p>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–æ–ª–∏ ¬´–°–ª—É–∂–±–∞ —Å–ø–∞—Å–µ–Ω–∏—è¬ª –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
        </section>
      </div>

    </main>
  </section>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ–∫ -->
  <div id="orientation-modal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫—É</h2>
        <button id="orientation-close" class="icon-btn">&times;</button>
      </div>

      <form id="orientation-form" class="modal-body">
        <div class="form-group">
          <label for="orientation-type">–¢–∏–ø *</label>
          <select id="orientation-type" class="input-select" required>
            <option value="–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∞">–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∞</option>
            <option value="–†–µ–π–¥">–†–µ–π–¥</option>
          </select>
        </div>
        <div class="form-group">
          <label for="orientation-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
          <input id="orientation-title" class="input-text" type="text"
                 placeholder="–ù–∞–ø—Ä., –¢—Ä–µ–∑–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å –∏–ª–∏ –†–∞–∑—ã—Å–∫–∏–≤–∞–µ—Ç—Å—è: –ò–≤–∞–Ω–æ–≤" required />
        </div>
        <div class="form-group">
          <label for="orientation-desc">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
          <textarea id="orientation-desc" class="input-textarea" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" required></textarea>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
          <button type="button" id="orientation-cancel" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
  <div id="person-modal" class="modal-backdrop hidden">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
        <button id="person-close" class="icon-btn">&times;</button>
      </div>
      <form id="person-form" class="modal-body">
        <div class="person-photo-placeholder">
          <div class="person-photo-inner">
            <div class="person-photo-icon">üì∑</div>
            <div>–í—Å—Ç–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ (Ctrl+V)</div>
            <div class="muted">(–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 800x1000px)</div>
          </div>
        </div>

        <div class="form-group">
          <label for="person-lastname">–§–∞–º–∏–ª–∏—è *</label>
          <input id="person-lastname" class="input-text" type="text" required />
        </div>
        <div class="form-group">
          <label for="person-firstname">–ò–º—è *</label>
          <input id="person-firstname" class="input-text" type="text" required />
        </div>
        <div class="form-group">
          <label for="person-middlename">–û—Ç—á–µ—Å—Ç–≤–æ</label>
          <input id="person-middlename" class="input-text" type="text" />
        </div>
        <div class="form-group">
          <label for="person-dob">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è *</label>
          <input id="person-dob" class="input-text" type="date" required />
        </div>
        <div class="form-group">
          <label for="person-flag">–§–ª–∞–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <textarea id="person-flag" class="input-textarea"
            placeholder="–î–µ—Ç–∞–ª–∏ —Ñ–ª–∞–≥–∞. –§–ª–∞–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –ø—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ä–≥–∞–Ω–æ–≤ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ."></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" id="person-cancel" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è -->
  <div id="vehicle-modal" class="modal-backdrop hidden">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h2>
        <button id="vehicle-close" class="icon-btn">&times;</button>
      </div>
      <form id="vehicle-form" class="modal-body">
        <div class="form-group">
          <label for="vehicle-owner-type">–¢–∏–ø –≤–ª–∞–¥–µ–ª—å—Ü–∞ *</label>
          <select id="vehicle-owner-type" class="input-select" required>
            <option value="person">–ü–µ—Ä—Å–æ–Ω–∞–∂</option>
          </select>
        </div>
        <div class="form-group">
          <label for="vehicle-person">–ü–µ—Ä—Å–æ–Ω–∞–∂ *</label>
          <select id="vehicle-person" class="input-select" required>
            <!-- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–ø–∏—Å–∫–æ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π -->
          </select>
        </div>
        <div class="form-group">
          <label for="vehicle-make">–ú–∞—Ä–∫–∞ *</label>
          <input id="vehicle-make" class="input-text" type="text" required />
        </div>
        <div class="form-group">
          <label for="vehicle-model">–ú–æ–¥–µ–ª—å *</label>
          <input id="vehicle-model" class="input-text" type="text" required />
        </div>
        <div class="form-group">
          <label for="vehicle-year">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ *</label>
          <input id="vehicle-year" class="input-text" type="number" required />
        </div>
        <div class="form-group">
          <label for="vehicle-color">–¶–≤–µ—Ç *</label>
          <input id="vehicle-color" class="input-text" type="text" required />
        </div>
        <div class="form-group">
          <label for="vehicle-plate-type">–¢–∏–ø –Ω–æ–º–µ—Ä–∞ *</label>
          <select id="vehicle-plate-type" class="input-select" required>
            <option value="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (A123BE12)">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (A123BE12)</option>
            <option value="–¢–∞–∫—Å–∏ (AB1234)">–¢–∞–∫—Å–∏ (AB1234)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="vehicle-plate">–ì–æ—Å. –Ω–æ–º–µ—Ä *</label>
          <input id="vehicle-plate" class="input-text" type="text" required />
          <div class="muted">
            –§–æ—Ä–º–∞—Ç: A123BE12 –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ, AB12345 –¥–ª—è —Ç–∞–∫—Å–∏ (—Ç–æ–ª—å–∫–æ A, B, E, K, M, H, O, P, C, T, Y, X).
          </div>
        </div>
        <div class="form-group">
          <label for="vehicle-vin">VIN</label>
          <input id="vehicle-vin" class="input-text" type="text" />
        </div>
        <div class="form-group">
          <label for="vehicle-flag">–§–ª–∞–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <textarea id="vehicle-flag" class="input-textarea"
            placeholder="–î–µ—Ç–∞–ª–∏ —Ñ–ª–∞–≥–∞. –§–ª–∞–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –ø—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ä–≥–∞–Ω–æ–≤ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ."></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" id="vehicle-cancel" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ -->
  <div id="vehicle-info-modal" class="modal-backdrop hidden">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2 id="vehicle-info-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ</h2>
        <button id="vehicle-info-close" class="icon-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="vehicle-info-box" id="vehicle-info-box">
          <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>
        <div class="modal-footer">
          <button type="button" id="vehicle-info-ok" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

</div> <!-- /app-root -->

<script>
  // === –ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ localStorage ===
  const STORAGE_KEY = 'elka_dispatcher_state_v2';

  const defaultState = {
    role: '',
    calls: [],
    resources: [],
    orientations: [],
    notes: '',
    persons: [],
    vehicles: [],
    nextCallId: 1,
    nextResourceId: 1,
    nextOrientationId: 1,
    nextPersonId: 1,
    nextVehicleId: 1,
  };

  let state = loadState();

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        return Object.assign({}, defaultState, JSON.parse(raw));
      }
    } catch (e) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ', e);
    }
    return { ...defaultState };
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    updateActiveCallsCounter();
  }

  // === DOM-—ç–ª–µ–º–µ–Ω—Ç—ã ===
  const roleScreen = document.getElementById('role-screen');
  const mainScreen = document.getElementById('main-screen');
  const roleSelect = document.getElementById('role-select');
  const roleContinueBtn = document.getElementById('role-continue');
  const currentRoleSpan = document.getElementById('current-role');
  const logoutBtn = document.getElementById('logout-btn');

  const dispatcherView = document.getElementById('dispatcher-view');
  const citizenView = document.getElementById('citizen-view');
  const forcesView = document.getElementById('forces-view');
  const rescueView = document.getElementById('rescue-view');

  // –î–∏—Å–ø–µ—Ç—á–µ—Ä
  const callForm = document.getElementById('call-form');
  const callStreetInput = document.getElementById('call-street');
  const callDescInput = document.getElementById('call-desc');
  const callsTableBody = document.getElementById('calls-table-body');

  const resForm = document.getElementById('resource-form');
  const resNameInput = document.getElementById('res-name');
  const resAppInput = document.getElementById('res-app');
  const resStatusSelect = document.getElementById('res-status');
  const resCallSelect = document.getElementById('res-call');
  const resourcesTableBody = document.getElementById('resources-table-body');

  const orientationModal = document.getElementById('orientation-modal');
  const orientationForm = document.getElementById('orientation-form');
  const addOrientationBtn = document.getElementById('add-orientation-btn');
  const orientationClose = document.getElementById('orientation-close');
  const orientationCancel = document.getElementById('orientation-cancel');
  const orientationTableBody = document.getElementById('orientation-table-body');

  const notesField = document.getElementById('notes-field');
  const notesStatus = document.getElementById('notes-status');
  const activeCallsCount = document.getElementById('active-calls-count');

  // –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π
  const personsGrid = document.getElementById('persons-grid');
  const vehiclesGrid = document.getElementById('vehicles-grid');
  const personsCountSpan = document.getElementById('persons-count');
  const vehiclesCountSpan = document.getElementById('vehicles-count');
  const addPersonBtn = document.getElementById('add-person-btn');
  const addVehicleBtn = document.getElementById('add-vehicle-btn');

  const personModal = document.getElementById('person-modal');
  const personForm = document.getElementById('person-form');
  const personClose = document.getElementById('person-close');
  const personCancel = document.getElementById('person-cancel');
  const personLastNameInput = document.getElementById('person-lastname');
  const personFirstNameInput = document.getElementById('person-firstname');
  const personMiddleNameInput = document.getElementById('person-middlename');
  const personDobInput = document.getElementById('person-dob');
  const personFlagInput = document.getElementById('person-flag');

  const vehicleModal = document.getElementById('vehicle-modal');
  const vehicleForm = document.getElementById('vehicle-form');
  const vehicleClose = document.getElementById('vehicle-close');
  const vehicleCancel = document.getElementById('vehicle-cancel');
  const vehicleOwnerTypeInput = document.getElementById('vehicle-owner-type');
  const vehiclePersonSelect = document.getElementById('vehicle-person');
  const vehicleMakeInput = document.getElementById('vehicle-make');
  const vehicleModelInput = document.getElementById('vehicle-model');
  const vehicleYearInput = document.getElementById('vehicle-year');
  const vehicleColorInput = document.getElementById('vehicle-color');
  const vehiclePlateTypeSelect = document.getElementById('vehicle-plate-type');
  const vehiclePlateInput = document.getElementById('vehicle-plate');
  const vehicleVinInput = document.getElementById('vehicle-vin');
  const vehicleFlagInput = document.getElementById('vehicle-flag');

  const vehicleInfoModal = document.getElementById('vehicle-info-modal');
  const vehicleInfoTitle = document.getElementById('vehicle-info-title');
  const vehicleInfoBox = document.getElementById('vehicle-info-box');
  const vehicleInfoClose = document.getElementById('vehicle-info-close');
  const vehicleInfoOk = document.getElementById('vehicle-info-ok');

  // === –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–æ–ª—è–º ===
  function showMainScreen() {
    roleScreen.classList.remove('screen-active');
    mainScreen.classList.add('screen-active');
    currentRoleSpan.textContent = state.role ? `(${formatRole(state.role)})` : '';
    updateRoleView();
  }

  function showRoleScreen() {
    mainScreen.classList.remove('screen-active');
    roleScreen.classList.add('screen-active');
  }

  function formatRole(code) {
    switch (code) {
      case 'dispatcher': return '–î–∏—Å–ø–µ—Ç—á–µ—Ä';
      case 'citizen': return '–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π';
      case 'forces': return '–°–∏–ª–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã';
      case 'rescue': return '–°–ª—É–∂–±–∞ —Å–ø–∞—Å–µ–Ω–∏—è';
      default: return code;
    }
  }

  function updateRoleView() {
    const allViews = [dispatcherView, citizenView, forcesView, rescueView];
    allViews.forEach(v => v.classList.remove('role-view-active'));

    if (state.role === 'dispatcher') {
      dispatcherView.classList.add('role-view-active');
    } else if (state.role === 'citizen') {
      citizenView.classList.add('role-view-active');
    } else if (state.role === 'forces') {
      forcesView.classList.add('role-view-active');
    } else if (state.role === 'rescue') {
      rescueView.classList.add('role-view-active');
    }
  }

  roleContinueBtn.addEventListener('click', () => {
    const value = roleSelect.value;
    if (!value) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å.');
      return;
    }
    state.role = value;
    saveState();
    showMainScreen();
  });

  logoutBtn.addEventListener('click', () => {
    if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–æ–ª—å –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É?')) {
      state.role = '';
      saveState();
      showRoleScreen();
    }
  });

  // === –í—ã–∑–æ–≤—ã ===
  if (callForm) {
    callForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const street = callStreetInput.value.trim();
      const desc = callDescInput.value.trim();
      if (!street || !desc) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —É–ª–∏—Ü—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.');
        return;
      }

      const call = {
        id: state.nextCallId++,
        street,
        desc,
        createdAt: new Date().toISOString(),
        status: '–ù–æ–≤—ã–π',
        resources: [],
      };
      state.calls.push(call);
      callStreetInput.value = '';
      callDescInput.value = '';
      saveState();
      renderCalls();
      renderResources();
      renderCallsInResourceSelect();
    });
  }

  function renderCalls() {
    callsTableBody.innerHTML = '';
    state.calls.forEach((call) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${call.id}</td>
        <td>${escapeHtml(call.street)}</td>
        <td>${formatDate(call.createdAt)}</td>
        <td>${escapeHtml(call.desc)}</td>
        <td>
          <select class="input-select input-select-sm call-status" data-id="${call.id}">
            <option value="–ù–æ–≤—ã–π"${call.status === '–ù–æ–≤—ã–π' ? ' selected' : ''}>–ù–æ–≤—ã–π</option>
            <option value="–í —Ä–∞–±–æ—Ç–µ"${call.status === '–í —Ä–∞–±–æ—Ç–µ' ? ' selected' : ''}>–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="–ó–∞–≤–µ—Ä—à—ë–Ω"${call.status === '–ó–∞–≤–µ—Ä—à—ë–Ω' ? ' selected' : ''}>–ó–∞–≤–µ—Ä—à—ë–Ω</option>
          </select>
        </td>
        <td>${call.resources.length ? call.resources.join(', ') : '‚Äî'}</td>
        <td>
          <button class="btn btn-ghost btn-sm" data-action="delete-call" data-id="${call.id}">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </td>
      `;
      callsTableBody.appendChild(tr);
    });
    updateActiveCallsCounter();
  }

  callsTableBody.addEventListener('change', (e) => {
    if (e.target.classList.contains('call-status')) {
      const id = Number(e.target.dataset.id);
      const call = state.calls.find(c => c.id === id);
      if (call) {
        call.status = e.target.value;
        saveState();
        updateActiveCallsCounter();
      }
    }
  });

  callsTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="delete-call"]');
    if (!btn) return;
    const id = Number(btn.dataset.id);
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–∑–æ–≤ #' + id + '?')) return;

    state.resources.forEach(r => {
      if (r.callId === id) r.callId = null;
    });
    state.calls = state.calls.filter(c => c.id !== id);
    saveState();
    renderCalls();
    renderResources();
    renderCallsInResourceSelect();
  });

  function renderCallsInResourceSelect() {
    const selected = resCallSelect.value;
    resCallSelect.innerHTML = '<option value="">‚Äî –ù–µ—Ç ‚Äî</option>';
    state.calls.forEach(call => {
      const opt = document.createElement('option');
      opt.value = call.id;
      opt.textContent = `#${call.id}: ${call.street}`;
      resCallSelect.appendChild(opt);
    });
    if (selected) {
      resCallSelect.value = selected;
    }
  }

  function updateActiveCallsCounter() {
    if (!activeCallsCount) return;
    const count = state.calls.filter(c => c.status !== '–ó–∞–≤–µ—Ä—à—ë–Ω').length;
    activeCallsCount.textContent = count;
  }

  // === –†–µ—Å—É—Ä—Å—ã ===
  resForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = resNameInput.value.trim();
    const app = resAppInput.value.trim();
    if (!name) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–µ—Å—É—Ä—Å–∞.');
      return;
    }

    const res = {
      id: state.nextResourceId++,
      name,
      app,
      status: resStatusSelect.value,
      callId: resCallSelect.value ? Number(resCallSelect.value) : null,
    };
    state.resources.push(res);
    resNameInput.value = '';
    resAppInput.value = '';
    resStatusSelect.value = '–°–≤–æ–±–æ–¥–µ–Ω';
    resCallSelect.value = '';

    saveState();
    renderResources();
    renderCalls();
  });

  function renderResources() {
    state.calls.forEach(c => c.resources = []);

    state.resources.forEach(res => {
      if (res.callId) {
        const call = state.calls.find(c => c.id === res.callId);
        if (call) {
          call.resources.push(res.name);
        } else {
          res.callId = null;
        }
      }
    });

    resourcesTableBody.innerHTML = '';
    state.resources.forEach(res => {
      const callLabel = res.callId ? '#' + res.callId : '‚Äî';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(res.name)}</td>
        <td>${escapeHtml(res.app || '')}</td>
        <td>${escapeHtml(res.status)}</td>
        <td>${callLabel}</td>
        <td>
          <button class="btn btn-ghost btn-sm" data-action="delete-resource" data-id="${res.id}">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </td>
      `;
      resourcesTableBody.appendChild(tr);
    });
  }

  resourcesTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="delete-resource"]');
    if (!btn) return;
    const id = Number(btn.dataset.id);
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å #' + id + '?')) return;

    state.resources = state.resources.filter(r => r.id !== id);
    saveState();
    renderResources();
    renderCalls();
  });

  // === –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∏ ===
  function openOrientationModal() {
    orientationModal.classList.remove('hidden');
  }

  function closeOrientationModal() {
    orientationModal.classList.add('hidden');
    orientationForm.reset();
  }

  addOrientationBtn.addEventListener('click', openOrientationModal);
  orientationClose.addEventListener('click', closeOrientationModal);
  orientationCancel.addEventListener('click', closeOrientationModal);

  orientationForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const type = document.getElementById('orientation-type').value;
    const title = document.getElementById('orientation-title').value.trim();
    const desc = document.getElementById('orientation-desc').value.trim();

    if (!title || !desc) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.');
      return;
    }

    const item = {
      id: state.nextOrientationId++,
      type,
      title,
      desc,
      active: true,
    };
    state.orientations.push(item);
    saveState();
    renderOrientations();
    closeOrientationModal();
  });

  function renderOrientations() {
    orientationTableBody.innerHTML = '';
    state.orientations.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(item.type)}</td>
        <td>${escapeHtml(item.title)}</td>
        <td>${escapeHtml(item.desc)}</td>
        <td>${item.active ? '–î–∞' : '–ù–µ—Ç'}</td>
        <td>
          <button class="btn btn-ghost btn-sm" data-action="toggle-orientation" data-id="${item.id}">
            ${item.active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
          </button>
          <button class="btn btn-ghost btn-sm" data-action="delete-orientation" data-id="${item.id}">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </td>
      `;
      orientationTableBody.appendChild(tr);
    });
  }

  orientationTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const id = Number(btn.dataset.id);
    const action = btn.dataset.action;
    const item = state.orientations.find(o => o.id === id);
    if (!item) return;

    if (action === 'toggle-orientation') {
      item.active = !item.active;
    } else if (action === 'delete-orientation') {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫—É?')) return;
      state.orientations = state.orientations.filter(o => o.id !== id);
    }
    saveState();
    renderOrientations();
  });

  // === –ó–∞–º–µ—Ç–∫–∏ ===
  if (notesField) {
    notesField.addEventListener('input', () => {
      state.notes = notesField.value;
      notesStatus.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
      saveState();
      setTimeout(() => {
        notesStatus.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ';
      }, 600);
    });
  }

  // === –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π: –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ ===
  addPersonBtn.addEventListener('click', () => {
    openPersonModal();
  });
  personClose.addEventListener('click', closePersonModal);
  personCancel.addEventListener('click', closePersonModal);

  function openPersonModal() {
    personForm.reset();
    personModal.classList.remove('hidden');
  }

  function closePersonModal() {
    personModal.classList.add('hidden');
  }

  personForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const lastName = personLastNameInput.value.trim();
    const firstName = personFirstNameInput.value.trim();
    const middleName = personMiddleNameInput.value.trim();
    const dob = personDobInput.value;
    const flag = personFlagInput.value.trim();

    if (!lastName || !firstName || !dob) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é, –∏–º—è –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è.');
      return;
    }

    const person = {
      id: state.nextPersonId++,
      lastName,
      firstName,
      middleName,
      dob,
      flag,
    };
    state.persons.push(person);
    saveState();
    renderPersons();
    closePersonModal();
  });

  function renderPersons() {
    personsGrid.innerHTML = '';
    const total = state.persons.length;
    personsCountSpan.textContent = total ? `${total} / 32` : '0 / 32';

    state.persons.forEach(p => {
      const card = document.createElement('div');
      card.className = 'person-card';

      const initials = (p.firstName[0] || '?') + (p.lastName[0] || '?');

      card.innerHTML = `
        <div class="person-photo-stub">${escapeHtml(initials)}</div>
        <div class="person-name">
          ${escapeHtml(p.firstName)} ${escapeHtml(p.lastName)}
        </div>
        <div class="person-dob">
          ${formatDob(p.dob)}
        </div>
        <div class="person-flags">
          ${p.flag ? '<span class="flag-label">–§–ª–∞–≥</span>' : ''}
        </div>
      `;
      personsGrid.appendChild(card);
    });

    // –ø–ª—é—Å –∫–∞—Ä—Ç–æ—á–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å"
    const addCard = document.createElement('div');
    addCard.className = 'person-card add-card';
    addCard.innerHTML = `
      <div class="add-card-icon">+</div>
      <div>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</div>
    `;
    addCard.addEventListener('click', openPersonModal);
    personsGrid.appendChild(addCard);

    // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —É –∞–≤—Ç–æ–º–æ–±–∏–ª—è
    renderVehiclePersonsSelect();
  }

  function renderVehiclePersonsSelect() {
    vehiclePersonSelect.innerHTML = '';
    if (!state.persons.length) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π';
      vehiclePersonSelect.appendChild(opt);
      return;
    }
    state.persons.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `${p.lastName} ${p.firstName} ${p.middleName || ''}`.trim();
      vehiclePersonSelect.appendChild(opt);
    });
  }

  // === –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π: –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ ===
  addVehicleBtn.addEventListener('click', () => {
    if (!state.persons.length) {
      alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.');
      return;
    }
    openVehicleModal();
  });

  vehicleClose.addEventListener('click', closeVehicleModal);
  vehicleCancel.addEventListener('click', closeVehicleModal);

  function openVehicleModal() {
    vehicleForm.reset();
    renderVehiclePersonsSelect();
    vehicleModal.classList.remove('hidden');
  }

  function closeVehicleModal() {
    vehicleModal.classList.add('hidden');
  }

  vehicleForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const ownerType = vehicleOwnerTypeInput.value;
    const personId = Number(vehiclePersonSelect.value);
    const make = vehicleMakeInput.value.trim();
    const model = vehicleModelInput.value.trim();
    const year = vehicleYearInput.value.trim();
    const color = vehicleColorInput.value.trim();
    const plateType = vehiclePlateTypeSelect.value;
    const plate = vehiclePlateInput.value.trim();
    const vin = vehicleVinInput.value.trim();
    const flag = vehicleFlagInput.value.trim();

    if (!ownerType || !personId || !make || !model || !year || !color || !plateType || !plate) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.');
      return;
    }

    const vehicle = {
      id: state.nextVehicleId++,
      ownerType,
      personId,
      make,
      model,
      year,
      color,
      plateType,
      plate,
      vin,
      flag,
    };
    state.vehicles.push(vehicle);
    saveState();
    renderVehicles();
    closeVehicleModal();
  });

  function renderVehicles() {
    vehiclesGrid.innerHTML = '';
    const total = state.vehicles.length;
    vehiclesCountSpan.textContent = total ? `${total} / 64` : '0 / 64';

    state.vehicles.forEach(v => {
      const card = document.createElement('div');
      card.className = 'vehicle-card';

      const owner = state.persons.find(p => p.id === v.personId);

      card.innerHTML = `
        <div class="vehicle-main">
          <div class="vehicle-make-model">
            ${escapeHtml(v.make)} ${escapeHtml(v.model)}
          </div>
          <div class="vehicle-plate">${escapeHtml(v.plate)}</div>
        </div>
        <div class="vehicle-owner">
          ${owner ? escapeHtml(owner.lastName + ' ' + owner.firstName) : '–í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω'}
        </div>
        <div class="vehicle-flags">
          ${v.flag ? '<span class="flag-label">–§–ª–∞–≥</span>' : ''}
        </div>
      `;

      card.addEventListener('click', () => openVehicleInfoModal(v.id));
      vehiclesGrid.appendChild(card);
    });

    // –∫–∞—Ä—Ç–æ—á–∫–∞ "–¥–æ–±–∞–≤–∏—Ç—å"
    const addCard = document.createElement('div');
    addCard.className = 'vehicle-card add-card';
    addCard.innerHTML = `
      <div class="add-card-icon">+</div>
      <div>–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</div>
    `;
    addCard.addEventListener('click', () => {
      if (!state.persons.length) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.');
      } else {
        openVehicleModal();
      }
    });
    vehiclesGrid.appendChild(addCard);
  }

  // –º–æ–¥–∞–ª–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ
  function openVehicleInfoModal(vehicleId) {
    const v = state.vehicles.find(x => x.id === vehicleId);
    if (!v) return;
    const owner = state.persons.find(p => p.id === v.personId);

    vehicleInfoTitle.textContent = `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ: ${v.make} ${v.model}`;
    const ownerName = owner
      ? `${owner.lastName} ${owner.firstName} ${owner.middleName || ''}`.trim()
      : '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
    const ownerDob = owner ? formatDob(owner.dob) : '‚Äî';

    vehicleInfoBox.innerHTML = `
      <p><strong>–ú–∞—Ä–∫–∞:</strong> ${escapeHtml(v.make)}</p>
      <p><strong>–ú–æ–¥–µ–ª—å:</strong> ${escapeHtml(v.model)}</p>
      <p><strong>–ì–æ–¥:</strong> ${escapeHtml(v.year)}</p>
      <p><strong>–¶–≤–µ—Ç:</strong> ${escapeHtml(v.color)}</p>
      <p><strong>–¢–∏–ø –Ω–æ–º–µ—Ä–∞:</strong> ${escapeHtml(v.plateType)}</p>
      <p><strong>–ì–æ—Å. –Ω–æ–º–µ—Ä:</strong> ${escapeHtml(v.plate)}</p>
      <p><strong>VIN:</strong> ${v.vin ? escapeHtml(v.vin) : '‚Äî'}</p>
      <p><strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> ${escapeHtml(ownerName)}</p>
      <p><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞:</strong> ${ownerDob}</p>
      ${v.flag ? `<p><strong>–§–ª–∞–≥:</strong> ${escapeHtml(v.flag)}</p>` : ''}
    `;

    vehicleInfoModal.classList.remove('hidden');
  }

  function closeVehicleInfoModal() {
    vehicleInfoModal.classList.add('hidden');
  }

  vehicleInfoClose.addEventListener('click', closeVehicleInfoModal);
  vehicleInfoOk.addEventListener('click', closeVehicleInfoModal);

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  function formatDate(iso) {
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    const pad = n => (n < 10 ? '0' + n : n);
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())} ${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
  }

  function formatDob(dobStr) {
    if (!dobStr) return '';
    const d = new Date(dobStr);
    if (isNaN(d.getTime())) return dobStr;
    const pad = n => (n < 10 ? '0' + n : n);
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // –ö–Ω–æ–ø–∫–∞ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ò–ò" ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ—Ä
  document.getElementById('ai-generate-btn').addEventListener('click', () => {
    const example = '–°–æ–æ–±—â–µ–Ω–∏–µ: –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –≤–æ–∑–ª–µ –ø–æ–¥—ä–µ–∑–¥–∞';
    callDescInput.value = example;
    alert('–ü—Ä–∏–º–µ—Ä –æ–ø–∏—Å–∞–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (—Ñ–∏–∫—Ç–∏–≤–Ω–æ).');
  });

  // –ò—Å—Ç–æ—Ä–∏—è ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
  document.getElementById('history-btn').addEventListener('click', () => {
    const finished = state.calls.filter(c => c.status === '–ó–∞–≤–µ—Ä—à—ë–Ω').length;
    alert('–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤: ' + finished);
  });

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  function init() {
    notesField && (notesField.value = state.notes || '');
    roleSelect.value = state.role || '';

    if (state.role) {
      showMainScreen();
    } else {
      showRoleScreen();
    }

    renderCalls();
    renderResources();
    renderOrientations();
    renderCallsInResourceSelect();
    renderPersons();
    renderVehicles();
  }

  init();
</script>
</body>
</html>
