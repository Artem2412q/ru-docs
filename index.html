<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–Å–ª–∫–∞</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div class="app-root">

  <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ -->
  <section id="role-screen" class="screen screen-active">
    <div class="role-card">
      <div class="logo-text">–Å –ª –∫ –∞</div>

      <label class="field-label" for="role-select">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</label>
      <div class="select-wrapper">
        <select id="role-select" class="input-select">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
          <option value="citizen">–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π</option>
          <option value="dispatcher">–î–∏—Å–ø–µ—Ç—á–µ—Ä</option>
          <option value="forces">–°–∏–ª–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</option>
          <option value="rescue">–°–ª—É–∂–±–∞ —Å–ø–∞—Å–µ–Ω–∏—è</option>
        </select>
      </div>

      <button id="role-continue" class="btn btn-primary">
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </button>
    </div>
  </section>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω -->
  <section id="main-screen" class="screen">
    <header class="topbar">
      <div class="topbar-left">
        <img src="img/logo.svg" alt="–Å–ª–∫–∞" class="topbar-logo" />
        <span class="topbar-title">–Å –ª –∫ –∞</span>
        <span id="current-role" class="topbar-role"></span>
      </div>
      <div class="topbar-right">
        <button class="icon-btn" title="–£–º–µ–Ω—å—à–∏—Ç—å —à—Ä–∏—Ñ—Ç">‚àí</button>
        <span class="counter" title="–ß–∏—Å–ª–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤" id="active-calls-count">0</span>
        <button class="icon-btn" title="–£–≤–µ–ª–∏—á–∏—Ç—å —à—Ä–∏—Ñ—Ç">+</button>
        <button class="icon-btn" title="–¢–µ–º–∞">üåô</button>
        <button class="icon-btn" id="logout-btn" title="–í—ã—Ö–æ–¥">‚ü≤ –í—ã—Ö–æ–¥</button>
      </div>
    </header>

    <main class="main-layout">
      <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –≤—ã–∑–æ–≤—ã -->
      <section class="card">
        <header class="card-header">
          <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –≤—ã–∑–æ–≤—ã</h2>
          <button class="btn btn-ghost" id="history-btn">‚ü≤ –ò—Å—Ç–æ—Ä–∏—è</button>
        </header>

        <form id="call-form" class="form-grid">
          <div class="form-group">
            <label for="call-street">–£–ª–∏—Ü–∞ *</label>
            <input id="call-street" class="input-text" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —É–ª–∏—Ü—É" required />
          </div>
          <div class="form-group">
            <label for="call-desc">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
            <input id="call-desc" class="input-text" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ" required />
          </div>
          <div class="form-group form-group-buttons">
            <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –≤—ã–∑–æ–≤</button>
            <button type="button" class="btn btn-secondary" id="ai-generate-btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ò–ò</button>
          </div>
        </form>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID –≤—ã–∑–æ–≤–∞</th>
                <th>–£–ª–∏—Ü–∞</th>
                <th>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–†–µ—Å—É—Ä—Å—ã</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="calls-table-body"></tbody>
          </table>
        </div>
      </section>

      <!-- –°–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ -->
      <section class="card">
        <header class="card-header">
          <h2>–°–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤</h2>
        </header>

        <form id="resource-form" class="form-grid form-grid-4">
          <div class="form-group">
            <label for="res-name">–ò–º—è</label>
            <input id="res-name" class="input-text" type="text" placeholder="–ù–∞–ø—Ä., –ü–∞—Ç—Ä—É–ª—å 12" />
          </div>
          <div class="form-group">
            <label for="res-app">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</label>
            <input id="res-app" class="input-text" type="text" placeholder="–†–∞—Ü–∏—è, Telegram..." />
          </div>
          <div class="form-group">
            <label for="res-status">–°—Ç–∞—Ç—É—Å</label>
            <select id="res-status" class="input-select">
              <option value="–°–≤–æ–±–æ–¥–µ–Ω">–°–≤–æ–±–æ–¥–µ–Ω</option>
              <option value="–ó–∞–Ω—è—Ç">–ó–∞–Ω—è—Ç</option>
              <option value="–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω">–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω</option>
            </select>
          </div>
          <div class="form-group">
            <label for="res-call">–ó–∞–∫—Ä–µ–ø–ª—ë–Ω –∑–∞ –≤—ã–∑–æ–≤–æ–º</label>
            <select id="res-call" class="input-select">
              <option value="">‚Äî –ù–µ—Ç ‚Äî</option>
            </select>
          </div>
          <div class="form-group form-group-buttons">
            <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Å—É—Ä—Å</button>
          </div>
        </form>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>–ò–º—è</th>
                <th>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–í—ã–∑–æ–≤</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="resources-table-body"></tbody>
          </table>
        </div>
      </section>

      <!-- –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∏ -->
      <section class="card">
        <header class="card-header">
          <h2>–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∏</h2>
          <button class="btn btn-primary" id="add-orientation-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </header>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>–¢–∏–ø</th>
                <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–î–µ–π—Å—Ç–≤—É–µ—Ç</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="orientation-table-body"></tbody>
          </table>
        </div>
      </section>

      <!-- –ó–∞–º–µ—Ç–∫–∏ -->
      <section class="card">
        <header class="card-header">
          <h2>–ó–∞–º–µ—Ç–∫–∏ <span id="notes-status" class="muted">–ó–∞–≥—Ä—É–∂–µ–Ω–æ</span></h2>
        </header>
        <textarea id="notes-field" class="notes-area" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ –∑–¥–µ—Å—å..."></textarea>
      </section>
    </main>
  </section>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ–∫ -->
  <div id="orientation-modal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫—É</h2>
        <button id="orientation-close" class="icon-btn">&times;</button>
      </div>

      <form id="orientation-form" class="modal-body">
        <div class="form-group">
          <label for="orientation-type">–¢–∏–ø *</label>
          <select id="orientation-type" class="input-select" required>
            <option value="–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∞">–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∞</option>
            <option value="–†–µ–π–¥">–†–µ–π–¥</option>
          </select>
        </div>
        <div class="form-group">
          <label for="orientation-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
          <input id="orientation-title" class="input-text" type="text"
                 placeholder="–ù–∞–ø—Ä., –¢—Ä–µ–∑–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å –∏–ª–∏ –†–∞–∑—ã—Å–∫–∏–≤–∞–µ—Ç—Å—è: –ò–≤–∞–Ω–æ–≤" required />
        </div>
        <div class="form-group">
          <label for="orientation-desc">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
          <textarea id="orientation-desc" class="input-textarea" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" required></textarea>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
          <button type="button" id="orientation-cancel" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // === –ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ localStorage ===
  const STORAGE_KEY = 'elka_dispatcher_state_v1';

  const defaultState = {
    role: '',
    calls: [],
    resources: [],
    orientations: [],
    notes: '',
    nextCallId: 1,
    nextResourceId: 1,
    nextOrientationId: 1,
  };

  let state = loadState();

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        return Object.assign({}, defaultState, JSON.parse(raw));
      }
    } catch (e) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ', e);
    }
    return { ...defaultState };
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    updateActiveCallsCounter();
  }

  // === DOM-—ç–ª–µ–º–µ–Ω—Ç—ã ===
  const roleScreen = document.getElementById('role-screen');
  const mainScreen = document.getElementById('main-screen');
  const roleSelect = document.getElementById('role-select');
  const roleContinueBtn = document.getElementById('role-continue');
  const currentRoleSpan = document.getElementById('current-role');
  const logoutBtn = document.getElementById('logout-btn');

  const callForm = document.getElementById('call-form');
  const callStreetInput = document.getElementById('call-street');
  const callDescInput = document.getElementById('call-desc');
  const callsTableBody = document.getElementById('calls-table-body');

  const resForm = document.getElementById('resource-form');
  const resNameInput = document.getElementById('res-name');
  const resAppInput = document.getElementById('res-app');
  const resStatusSelect = document.getElementById('res-status');
  const resCallSelect = document.getElementById('res-call');
  const resourcesTableBody = document.getElementById('resources-table-body');

  const orientationModal = document.getElementById('orientation-modal');
  const orientationForm = document.getElementById('orientation-form');
  const addOrientationBtn = document.getElementById('add-orientation-btn');
  const orientationClose = document.getElementById('orientation-close');
  const orientationCancel = document.getElementById('orientation-cancel');
  const orientationTableBody = document.getElementById('orientation-table-body');

  const notesField = document.getElementById('notes-field');
  const notesStatus = document.getElementById('notes-status');
  const activeCallsCount = document.getElementById('active-calls-count');

  // === –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —ç–∫—Ä–∞–Ω–∞–º ===
  function showMainScreen() {
    roleScreen.classList.remove('screen-active');
    mainScreen.classList.add('screen-active');
    currentRoleSpan.textContent = state.role ? `(${formatRole(state.role)})` : '';
  }

  function showRoleScreen() {
    mainScreen.classList.remove('screen-active');
    roleScreen.classList.add('screen-active');
  }

  function formatRole(code) {
    switch (code) {
      case 'dispatcher': return '–î–∏—Å–ø–µ—Ç—á–µ—Ä';
      case 'citizen': return '–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π';
      case 'forces': return '–°–∏–ª–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã';
      case 'rescue': return '–°–ª—É–∂–±–∞ —Å–ø–∞—Å–µ–Ω–∏—è';
      default: return code;
    }
  }

  roleContinueBtn.addEventListener('click', () => {
    const value = roleSelect.value;
    if (!value) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å.');
      return;
    }
    state.role = value;
    saveState();
    showMainScreen();
  });

  logoutBtn.addEventListener('click', () => {
    if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–æ–ª—å –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É?')) {
      state.role = '';
      saveState();
      showRoleScreen();
    }
  });

  // === –í—ã–∑–æ–≤—ã ===
  callForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const street = callStreetInput.value.trim();
    const desc = callDescInput.value.trim();
    if (!street || !desc) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —É–ª–∏—Ü—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.');
      return;
    }

    const call = {
      id: state.nextCallId++,
      street,
      desc,
      createdAt: new Date().toISOString(),
      status: '–ù–æ–≤—ã–π',
      resources: [],
    };
    state.calls.push(call);
    callStreetInput.value = '';
    callDescInput.value = '';
    saveState();
    renderCalls();
    renderResources(); // —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å —Å–ø–∏—Å–∫–∏ –≤—ã–∑–æ–≤–æ–≤ –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤
    renderCallsInResourceSelect();
  });

  function renderCalls() {
    callsTableBody.innerHTML = '';
    state.calls.forEach((call) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${call.id}</td>
        <td>${escapeHtml(call.street)}</td>
        <td>${formatDate(call.createdAt)}</td>
        <td>${escapeHtml(call.desc)}</td>
        <td>
          <select class="input-select input-select-sm call-status" data-id="${call.id}">
            <option value="–ù–æ–≤—ã–π"${call.status === '–ù–æ–≤—ã–π' ? ' selected' : ''}>–ù–æ–≤—ã–π</option>
            <option value="–í —Ä–∞–±–æ—Ç–µ"${call.status === '–í —Ä–∞–±–æ—Ç–µ' ? ' selected' : ''}>–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="–ó–∞–≤–µ—Ä—à—ë–Ω"${call.status === '–ó–∞–≤–µ—Ä—à—ë–Ω' ? ' selected' : ''}>–ó–∞–≤–µ—Ä—à—ë–Ω</option>
          </select>
        </td>
        <td>${call.resources.length ? call.resources.join(', ') : '‚Äî'}</td>
        <td>
          <button class="btn btn-ghost btn-sm" data-action="delete-call" data-id="${call.id}">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </td>
      `;
      callsTableBody.appendChild(tr);
    });
    updateActiveCallsCounter();
  }

  callsTableBody.addEventListener('change', (e) => {
    if (e.target.classList.contains('call-status')) {
      const id = Number(e.target.dataset.id);
      const call = state.calls.find(c => c.id === id);
      if (call) {
        call.status = e.target.value;
        saveState();
      }
    }
  });

  callsTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="delete-call"]');
    if (!btn) return;
    const id = Number(btn.dataset.id);
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–∑–æ–≤ #' + id + '?')) return;

    // –æ—Ç–≤—è–∂–µ–º —Ä–µ—Å—É—Ä—Å—ã
    state.resources.forEach(r => {
      if (r.callId === id) r.callId = null;
    });
    state.calls = state.calls.filter(c => c.id !== id);
    saveState();
    renderCalls();
    renderResources();
    renderCallsInResourceSelect();
  });

  function renderCallsInResourceSelect() {
    const selected = resCallSelect.value;
    resCallSelect.innerHTML = '<option value="">‚Äî –ù–µ—Ç ‚Äî</option>';
    state.calls.forEach(call => {
      const opt = document.createElement('option');
      opt.value = call.id;
      opt.textContent = `#${call.id}: ${call.street}`;
      resCallSelect.appendChild(opt);
    });
    if (selected) {
      resCallSelect.value = selected;
    }
  }

  function updateActiveCallsCounter() {
    const count = state.calls.filter(c => c.status !== '–ó–∞–≤–µ—Ä—à—ë–Ω').length;
    activeCallsCount.textContent = count;
  }

  // === –†–µ—Å—É—Ä—Å—ã ===
  resForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = resNameInput.value.trim();
    const app = resAppInput.value.trim();
    if (!name) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–µ—Å—É—Ä—Å–∞.');
      return;
    }

    const res = {
      id: state.nextResourceId++,
      name,
      app,
      status: resStatusSelect.value,
      callId: resCallSelect.value ? Number(resCallSelect.value) : null,
    };
    state.resources.push(res);
    resNameInput.value = '';
    resAppInput.value = '';
    resStatusSelect.value = '–°–≤–æ–±–æ–¥–µ–Ω';
    resCallSelect.value = '';

    saveState();
    renderResources();
    renderCalls(); // –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É "—Ä–µ—Å—É—Ä—Å—ã" —É –≤—ã–∑–æ–≤–æ–≤
  });

  function renderResources() {
    // —Å–Ω–∞—á–∞–ª–∞ –æ—á–∏—Å—Ç–∏–º –ø—Ä–∏–≤—è–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –≤—ã–∑–æ–≤–∞—Ö
    state.calls.forEach(c => c.resources = []);

    // –ø–æ—Å—Ç—Ä–æ–∏–º —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ
    state.resources.forEach(res => {
      if (res.callId) {
        const call = state.calls.find(c => c.id === res.callId);
        if (call) {
          call.resources.push(res.name);
        } else {
          res.callId = null; // –∑–∞—â–∏—Ç–∞ –æ—Ç "–±–∏—Ç—ã—Ö" —Å—Å—ã–ª–æ–∫
        }
      }
    });

    resourcesTableBody.innerHTML = '';
    state.resources.forEach(res => {
      const callLabel = res.callId
        ? '#' + res.callId
        : '‚Äî';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(res.name)}</td>
        <td>${escapeHtml(res.app || '')}</td>
        <td>${escapeHtml(res.status)}</td>
        <td>${callLabel}</td>
        <td>
          <button class="btn btn-ghost btn-sm" data-action="delete-resource" data-id="${res.id}">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </td>
      `;
      resourcesTableBody.appendChild(tr);
    });
  }

  resourcesTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="delete-resource"]');
    if (!btn) return;
    const id = Number(btn.dataset.id);
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å #' + id + '?')) return;

    state.resources = state.resources.filter(r => r.id !== id);
    saveState();
    renderResources();
    renderCalls();
  });

  // === –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∏ ===
  function openOrientationModal() {
    orientationModal.classList.remove('hidden');
  }

  function closeOrientationModal() {
    orientationModal.classList.add('hidden');
    orientationForm.reset();
  }

  addOrientationBtn.addEventListener('click', openOrientationModal);
  orientationClose.addEventListener('click', closeOrientationModal);
  orientationCancel.addEventListener('click', closeOrientationModal);

  orientationForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const type = document.getElementById('orientation-type').value;
    const title = document.getElementById('orientation-title').value.trim();
    const desc = document.getElementById('orientation-desc').value.trim();

    if (!title || !desc) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.');
      return;
    }

    const item = {
      id: state.nextOrientationId++,
      type,
      title,
      desc,
      active: true,
    };
    state.orientations.push(item);
    saveState();
    renderOrientations();
    closeOrientationModal();
  });

  function renderOrientations() {
    orientationTableBody.innerHTML = '';
    state.orientations.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(item.type)}</td>
        <td>${escapeHtml(item.title)}</td>
        <td>${escapeHtml(item.desc)}</td>
        <td>${item.active ? '–î–∞' : '–ù–µ—Ç'}</td>
        <td>
          <button class="btn btn-ghost btn-sm" data-action="toggle-orientation" data-id="${item.id}">
            ${item.active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
          </button>
          <button class="btn btn-ghost btn-sm" data-action="delete-orientation" data-id="${item.id}">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </td>
      `;
      orientationTableBody.appendChild(tr);
    });
  }

  orientationTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const id = Number(btn.dataset.id);
    const action = btn.dataset.action;
    const item = state.orientations.find(o => o.id === id);
    if (!item) return;

    if (action === 'toggle-orientation') {
      item.active = !item.active;
    } else if (action === 'delete-orientation') {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫—É?')) return;
      state.orientations = state.orientations.filter(o => o.id !== id);
    }
    saveState();
    renderOrientations();
  });

  // === –ó–∞–º–µ—Ç–∫–∏ ===
  notesField.addEventListener('input', () => {
    state.notes = notesField.value;
    notesStatus.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
    saveState();
    setTimeout(() => {
      notesStatus.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ';
    }, 600);
  });

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  function formatDate(iso) {
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    const pad = n => (n < 10 ? '0' + n : n);
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())} ${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
  }

<section class="card">
  <header class="card-header">
    <h2>–ö–∞—Ä—Ç–∞</h2>
  </header>
  <div class="map-container">
    <iframe
      src="https://map.vzkn.ru/"
      width="100%"
      height="500"
      style="border:0;"
      allowfullscreen
      loading="lazy">
    </iframe>
  </div>
</section>

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // –ö–Ω–æ–ø–∫–∞ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ò–ò" ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ—Ä
  document.getElementById('ai-generate-btn').addEventListener('click', () => {
    const example = '–°–æ–æ–±—â–µ–Ω–∏–µ: –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –≤–æ–∑–ª–µ –ø–æ–¥—ä–µ–∑–¥–∞';
    callDescInput.value = example;
    alert('–ü—Ä–∏–º–µ—Ä –æ–ø–∏—Å–∞–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (—Ñ–∏–∫—Ç–∏–≤–Ω–æ).');
  });

  // –ò—Å—Ç–æ—Ä–∏—è ‚Äî –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö
  document.getElementById('history-btn').addEventListener('click', () => {
    const finished = state.calls.filter(c => c.status === '–ó–∞–≤–µ—Ä—à—ë–Ω').length;
    alert('–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤: ' + finished);
  });

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  function init() {
    // –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    notesField.value = state.notes || '';
    roleSelect.value = state.role || '';

    if (state.role) {
      showMainScreen();
    } else {
      showRoleScreen();
    }

    renderCalls();
    renderResources();
    renderOrientations();
    renderCallsInResourceSelect();
  }

  init();
</script>
</body>
</html>
